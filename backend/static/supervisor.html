<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<meta name="theme-color" content="#FF8C00"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Supervisor"/>
<link rel="manifest" href="/api/supervisor/manifest.json"/>
<link rel="apple-touch-icon" href="/api/supervisor/icon-192.png"/>
<title>Supervisor - Cronograma de Obra</title>
<style>
  :root{
    --neon:#FF8C00;
    --neon-rgb:255,140,0;
    --bg:#0f0f10; --card:#16171a; --muted:#9aa0a6; --text:#e8eaed;
    --border:#2a2d33; --danger:#ff5964; --success:#22c55e;
    --progress-text-before:var(--neon); --progress-text-after:#0b0c0f;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  body{padding-bottom:80px}
  
  /* Install Banner */
  .install-banner{display:none;position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#FF8C00,#FF6B00);color:#fff;padding:12px 16px;z-index:10000;text-align:center}
  .install-banner.show{display:flex;align-items:center;justify-content:center;gap:12px}
  .install-banner button{background:#fff;color:#FF8C00;border:none;padding:8px 16px;border-radius:8px;font-weight:700;cursor:pointer}
  .install-banner .close{background:transparent;color:#fff;font-size:1.2rem}
  
  /* Login Screen */
  .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px}
  .login-screen.hidden{display:none}
  .login-box{background:var(--card);border-radius:16px;padding:32px;width:100%;max-width:400px;text-align:center}
  .login-box h1{font-size:1.5rem;margin-bottom:8px;color:var(--neon)}
  .login-box p{color:var(--muted);margin-bottom:24px}
  .login-box .input{width:100%;padding:14px 16px;border-radius:10px;border:1px solid var(--border);background:#0e0f12;color:var(--text);font-size:1rem;margin-bottom:12px}
  .login-box .btn{width:100%;padding:14px;border:none;border-radius:10px;background:var(--neon);color:#fff;font-size:1rem;font-weight:700;cursor:pointer}
  .login-box .error{color:var(--danger);margin-top:12px;font-size:.9rem}
  
  /* Main App */
  .app-screen{display:none}
  .app-screen.show{display:block}
  
  .container{max-width:1100px;margin:0 auto;padding:12px 8px}
  
  /* Header */
  .header{background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px;position:sticky;top:0;z-index:100}
  .header-content{display:flex;align-items:center;justify-content:space-between;max-width:1100px;margin:0 auto}
  .header h1{font-size:1.1rem;color:var(--neon)}
  .header .user-info{font-size:.85rem;color:var(--muted)}
  .header .logout-btn{background:transparent;border:1px solid var(--danger);color:var(--danger);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.85rem}
  
  /* Cards */
  .card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:12px}
  .card-title{font-size:1rem;font-weight:700;margin-bottom:12px;color:var(--text)}
  
  /* Select Obra */
  .select-obra{width:100%;padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:#0e0f12;color:var(--text);font-size:1rem}
  
  /* Stage */
  .label{font-size:.85rem;color:var(--muted);margin-bottom:6px;display:block}
  .input{width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);background:#0e0f12;color:var(--text);font-size:1rem}
  .btn{padding:12px 16px;border:1px solid var(--border);background:#0e0f12;color:var(--text);border-radius:8px;cursor:pointer;font-size:.95rem}
  .btn:hover{filter:brightness(1.1)}
  .btn-primary{border-color:var(--neon);background:var(--neon);color:#fff}
  .btn-success{border-color:var(--success);background:var(--success);color:#fff}
  .btn-danger{border-color:var(--danger);color:var(--danger)}
  
  .stage{background:#0e0f12;padding:12px;border-radius:10px;margin-bottom:10px;border-left:3px solid var(--neon)}
  .stage-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .stage-name{color:var(--neon);font-weight:700;cursor:pointer}
  .stage-name:hover{text-decoration:underline}
  
  .progress{position:relative;width:100%;height:28px;background:#0b0c0f;border:1px solid var(--neon);border-radius:999px;overflow:hidden;cursor:pointer}
  .progress .fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:var(--neon);box-shadow:0 0 16px var(--neon);transition:width .3s}
  .progress .pct-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--neon)}
  
  /* Media */
  .media-grid{margin-top:12px}
  .media-card{background:#1a1b1f;border-radius:8px;padding:12px;margin-bottom:10px}
  .photo-box{position:relative;min-height:180px;border-radius:8px;background:#2a2d33;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer}
  .photo-box img{width:100%;height:100%;object-fit:cover}
  .photo-hint{color:var(--muted);text-align:center}
  .photo-hint svg{width:48px;height:48px;margin-bottom:8px;opacity:.5}
  
  .rec-bar{display:flex;align-items:center;gap:10px;margin-top:10px;padding:10px;background:#0e0f12;border-radius:8px}
  .rec-bar .timer{font-weight:900;font-family:monospace;font-size:1.1rem}
  .rec-bar .mic-btn{width:48px;height:48px;border-radius:50%;border:2px solid var(--neon);background:transparent;color:var(--neon);font-size:1.5rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
  .rec-bar .mic-btn.recording{background:var(--danger);border-color:var(--danger);color:#fff;animation:pulse 1s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
  
  .audio-player{width:100%;margin-top:10px}
  .note{width:100%;padding:10px;border:1px dashed var(--neon);background:#0e0f12;color:var(--text);border-radius:8px;resize:vertical;min-height:60px;margin-top:10px}
  
  /* FAB */
  .fab{position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--neon);color:#fff;border:none;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 20px rgba(var(--neon-rgb),.4);z-index:1000}
  
  /* Action buttons */
  .action-bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
  
  /* Icon buttons */
  .icon-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center}
  .icon-btn:hover{border-color:var(--danger);color:var(--danger)}
  
  /* Sheet */
  .sheet{position:fixed;inset:0;display:none;z-index:9999}
  .sheet.show{display:block}
  .sheet .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6)}
  .sheet .panel{position:absolute;left:0;right:0;bottom:0;background:#111214;border-radius:20px 20px 0 0;padding:24px;max-height:80vh;overflow-y:auto}
  .sheet h3{font-size:1.1rem;margin-bottom:16px}
  .sheet .range{width:100%;accent-color:var(--neon);margin:16px 0}
  .sheet .value{font-size:2.5rem;font-weight:900;text-align:center;color:var(--neon)}
  .sheet .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:20px}
  
  /* Toast */
  .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 24px;border-radius:8px;z-index:10001;display:none}
  .toast.show{display:block;animation:fadeIn .3s}
  @keyframes fadeIn{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
  
  /* Loading */
  .loading{display:flex;align-items:center;justify-content:center;padding:40px}
  .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--neon);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  
  /* Empty state */
  .empty{text-align:center;padding:40px;color:var(--muted)}
  .empty svg{width:64px;height:64px;margin-bottom:16px;opacity:.3}
  
  /* Responsive */
  @media(max-width:600px){
    .container{padding:8px}
    .card{padding:12px;border-radius:10px}
    .header h1{font-size:1rem}
    .fab{bottom:16px;right:16px;width:50px;height:50px;font-size:1.3rem}
  }
</style>
</head>
<body>

<!-- Install Banner -->
<div id="installBanner" class="install-banner">
  <span>üì≤ Instale o App do Supervisor</span>
  <button id="installBtn">Instalar</button>
  <button class="close" id="closeBanner">√ó</button>
</div>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <h1>üèóÔ∏è Supervisor</h1>
    <p>Cronograma de Obra</p>
    <input type="email" id="loginEmail" class="input" placeholder="Email de acesso"/>
    <input type="password" id="loginSenha" class="input" placeholder="Senha"/>
    <button id="loginBtn" class="btn btn-primary">Entrar</button>
    <div id="loginError" class="error"></div>
  </div>
</div>

<!-- Main App -->
<div id="appScreen" class="app-screen">
  <div class="header">
    <div class="header-content">
      <div>
        <h1 id="empresaNome">Supervisor</h1>
        <div class="user-info" id="supervisorNome"></div>
      </div>
      <button class="logout-btn" id="logoutBtn">Sair</button>
    </div>
  </div>

  <div class="container">
    <!-- Select Obra -->
    <div class="card">
      <div class="card-title">Selecione a Obra</div>
      <select id="selectObra" class="select-obra">
        <option value="">-- Selecione um or√ßamento aprovado --</option>
      </select>
    </div>

    <!-- Cronograma Section (hidden until obra selected) -->
    <div id="cronogramaSection" style="display:none">
      <!-- Project Info -->
      <div class="card">
        <label class="label">Nome do projeto</label>
        <input id="projetoNome" class="input" placeholder="Nome do projeto"/>
        
        <label class="label" style="margin-top:12px">Data do cronograma</label>
        <input id="cronogramaData" type="date" class="input"/>
        
        <div style="margin-top:16px">
          <label class="label">Progresso geral</label>
          <div class="progress" id="progressoGeral" title="Toque para ajustar">
            <div class="fill" id="progressoFill"></div>
            <div class="pct-label" id="progressoLabel">0%</div>
          </div>
        </div>
      </div>

      <!-- Stages -->
      <div class="card">
        <div class="card-title">Etapas da Obra</div>
        <div id="stagesContainer"></div>
        <button id="addStageBtn" class="btn btn-primary" style="width:100%;margin-top:12px">+ Adicionar Etapa</button>
      </div>

      <!-- Actions -->
      <div class="card">
        <div class="action-bar">
          <button id="saveBtn" class="btn btn-primary" style="flex:1">üíæ Salvar</button>
          <button id="sendClientBtn" class="btn btn-success" style="flex:1">üì§ Enviar para Cliente</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Slider Sheet -->
<div id="sliderSheet" class="sheet">
  <div class="backdrop"></div>
  <div class="panel">
    <h3 id="sheetTitle">Ajustar percentual</h3>
    <div class="value" id="sheetValue">0%</div>
    <input type="range" id="sheetRange" class="range" min="0" max="100" value="0"/>
    <div class="actions">
      <button id="sheetCancel" class="btn">Cancelar</button>
      <button id="sheetOk" class="btn btn-primary">Confirmar</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- FAB for adding stage -->
<button id="fabAddStage" class="fab" style="display:none">+</button>

<script>
const API_BASE = window.location.origin + '/api';
let deferredPrompt = null;
let supervisor = null;
let empresa = null;
let currentOrcamento = null;
let cronograma = {
  projeto_nome: '',
  data: new Date().toISOString().split('T')[0],
  progresso_geral: 0,
  modo_progresso: 'auto',
  etapas: []
};

// ===== PWA Install =====
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBanner').classList.add('show');
});

document.getElementById('installBtn').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById('installBanner').classList.remove('show');
});

document.getElementById('closeBanner').addEventListener('click', () => {
  document.getElementById('installBanner').classList.remove('show');
});

// ===== Utils =====
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// Fun√ß√£o para comprimir imagem antes de enviar - OTIMIZADA PARA MOBILE
async function compressImage(file, maxSize = 600, quality = 0.6) {
  return new Promise((resolve, reject) => {
    // Criar URL tempor√°ria para a imagem (mais eficiente que FileReader)
    const url = URL.createObjectURL(file);
    const img = new Image();
    
    img.onload = () => {
      URL.revokeObjectURL(url); // Liberar mem√≥ria
      
      // Calcular novas dimens√µes
      let width = img.width;
      let height = img.height;
      
      // Redimensionar para no m√°ximo 600px no maior lado
      if (width > height) {
        if (width > maxSize) {
          height = Math.round((height * maxSize) / width);
          width = maxSize;
        }
      } else {
        if (height > maxSize) {
          width = Math.round((width * maxSize) / height);
          height = maxSize;
        }
      }
      
      // Criar canvas pequeno
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      
      // Converter para blob com qualidade baixa
      canvas.toBlob(
        (blob) => {
          // Limpar canvas da mem√≥ria
          canvas.width = 1;
          canvas.height = 1;
          
          if (blob) {
            resolve(new File([blob], 'foto.jpg', { type: 'image/jpeg' }));
          } else {
            // Fallback: retornar arquivo original se falhar
            resolve(file);
          }
        },
        'image/jpeg',
        quality
      );
    };
    
    img.onerror = () => {
      URL.revokeObjectURL(url);
      // Em caso de erro, tentar enviar arquivo original
      resolve(file);
    };
    
    img.src = url;
  });
}

// ===== Login =====
document.getElementById('loginBtn').addEventListener('click', async () => {
  const email = document.getElementById('loginEmail').value;
  const senha = document.getElementById('loginSenha').value;
  const errorEl = document.getElementById('loginError');
  
  if (!email || !senha) {
    errorEl.textContent = 'Preencha email e senha';
    return;
  }
  
  try {
    const res = await fetch(`${API_BASE}/supervisor/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ login_email: email, login_senha: senha })
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      errorEl.textContent = data.detail || 'Erro ao fazer login';
      return;
    }
    
    supervisor = data.supervisor;
    empresa = data.empresa;
    
    localStorage.setItem('supervisor', JSON.stringify(supervisor));
    localStorage.setItem('empresa', JSON.stringify(empresa));
    
    showApp();
  } catch (err) {
    errorEl.textContent = 'Erro de conex√£o';
  }
});

// ===== Logout =====
document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('supervisor');
  localStorage.removeItem('empresa');
  supervisor = null;
  empresa = null;
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('appScreen').classList.remove('show');
});

// ===== Check stored login =====
function checkStoredLogin() {
  const stored = localStorage.getItem('supervisor');
  const storedEmpresa = localStorage.getItem('empresa');
  if (stored && storedEmpresa) {
    supervisor = JSON.parse(stored);
    empresa = JSON.parse(storedEmpresa);
    showApp();
  }
}

// ===== Show App =====
async function showApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('appScreen').classList.add('show');
  
  document.getElementById('empresaNome').textContent = empresa?.nome || 'Supervisor';
  document.getElementById('supervisorNome').textContent = supervisor?.nome || '';
  
  await loadOrcamentos();
}

// ===== Load Or√ßamentos =====
async function loadOrcamentos() {
  try {
    const res = await fetch(`${API_BASE}/supervisor/${supervisor.id}/orcamentos`);
    const orcamentos = await res.json();
    
    const select = document.getElementById('selectObra');
    select.innerHTML = '<option value="">-- Selecione um or√ßamento aprovado --</option>';
    
    orcamentos.forEach(orc => {
      const opt = document.createElement('option');
      opt.value = orc.id;
      opt.textContent = `${orc.numero_orcamento || 'S/N'} - ${orc.cliente_nome || 'Cliente'} - R$ ${(orc.valor_total || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
      opt.dataset.orcamento = JSON.stringify(orc);
      select.appendChild(opt);
    });
  } catch (err) {
    toast('Erro ao carregar or√ßamentos');
  }
}

// ===== Select Obra Change =====
document.getElementById('selectObra').addEventListener('change', async (e) => {
  const selectedOpt = e.target.selectedOptions[0];
  if (!selectedOpt?.value) {
    document.getElementById('cronogramaSection').style.display = 'none';
    document.getElementById('fabAddStage').style.display = 'none';
    currentOrcamento = null;
    return;
  }
  
  currentOrcamento = JSON.parse(selectedOpt.dataset.orcamento);
  
  // Reset cronograma
  cronograma = {
    projeto_nome: currentOrcamento.cliente_nome || '',
    data: new Date().toISOString().split('T')[0],
    progresso_geral: 0,
    modo_progresso: 'auto',
    etapas: []
  };
  
  // Check if there's existing cronograma for today
  try {
    const res = await fetch(`${API_BASE}/supervisor/${supervisor.id}/cronograma/${currentOrcamento.id}/${cronograma.data}`);
    if (res.ok) {
      const existing = await res.json();
      if (existing) {
        cronograma = {
          id: existing.id,
          projeto_nome: existing.projeto_nome,
          data: existing.data,
          progresso_geral: existing.progresso_geral,
          modo_progresso: existing.modo_progresso,
          etapas: existing.etapas || []
        };
      }
    }
  } catch (err) {}
  
  document.getElementById('projetoNome').value = cronograma.projeto_nome;
  document.getElementById('cronogramaData').value = cronograma.data;
  updateProgressBar(cronograma.progresso_geral);
  
  renderStages();
  
  document.getElementById('cronogramaSection').style.display = 'block';
  document.getElementById('fabAddStage').style.display = 'block';
});

// ===== Date Change =====
document.getElementById('cronogramaData').addEventListener('change', async (e) => {
  const newDate = e.target.value;
  cronograma.data = newDate;
  
  // Check if there's existing cronograma for this date
  try {
    const res = await fetch(`${API_BASE}/supervisor/${supervisor.id}/cronograma/${currentOrcamento.id}/${newDate}`);
    if (res.ok) {
      const existing = await res.json();
      if (existing) {
        cronograma = {
          id: existing.id,
          projeto_nome: existing.projeto_nome,
          data: existing.data,
          progresso_geral: existing.progresso_geral,
          modo_progresso: existing.modo_progresso,
          etapas: existing.etapas || []
        };
        document.getElementById('projetoNome').value = cronograma.projeto_nome;
        updateProgressBar(cronograma.progresso_geral);
        renderStages();
        toast('Cronograma carregado');
      } else {
        // New date, reset stages
        cronograma.etapas = [];
        cronograma.progresso_geral = 0;
        updateProgressBar(0);
        renderStages();
      }
    }
  } catch (err) {}
});

// ===== Progress Bar =====
function updateProgressBar(pct) {
  document.getElementById('progressoFill').style.width = pct + '%';
  document.getElementById('progressoLabel').textContent = pct + '%';
}

document.getElementById('progressoGeral').addEventListener('click', () => {
  openSlider({
    title: 'Progresso Geral',
    initial: cronograma.progresso_geral,
    onConfirm: (v) => {
      cronograma.progresso_geral = v;
      cronograma.modo_progresso = 'manual';
      updateProgressBar(v);
    }
  });
});

// ===== Slider Sheet =====
function openSlider({ title, initial, onConfirm }) {
  const sheet = document.getElementById('sliderSheet');
  document.getElementById('sheetTitle').textContent = title;
  document.getElementById('sheetValue').textContent = initial + '%';
  document.getElementById('sheetRange').value = initial;
  
  sheet.classList.add('show');
  
  const range = document.getElementById('sheetRange');
  const valueEl = document.getElementById('sheetValue');
  
  range.oninput = () => valueEl.textContent = range.value + '%';
  
  document.querySelector('#sliderSheet .backdrop').onclick = () => sheet.classList.remove('show');
  document.getElementById('sheetCancel').onclick = () => sheet.classList.remove('show');
  document.getElementById('sheetOk').onclick = () => {
    onConfirm(parseInt(range.value));
    sheet.classList.remove('show');
  };
}

// ===== Render Stages =====
function renderStages() {
  const container = document.getElementById('stagesContainer');
  container.innerHTML = '';
  
  if (cronograma.etapas.length === 0) {
    container.innerHTML = '<div class="empty"><p>Nenhuma etapa adicionada</p></div>';
    return;
  }
  
  cronograma.etapas.forEach((etapa, idx) => {
    container.appendChild(createStageElement(etapa, idx));
  });
  
  // Update auto progress
  if (cronograma.modo_progresso === 'auto') {
    const avg = cronograma.etapas.length 
      ? Math.round(cronograma.etapas.reduce((a, e) => a + (e.percentual || 0), 0) / cronograma.etapas.length)
      : 0;
    cronograma.progresso_geral = avg;
    updateProgressBar(avg);
  }
}

function createStageElement(etapa, idx) {
  const div = document.createElement('div');
  div.className = 'stage';
  
  div.innerHTML = `
    <div class="stage-head">
      <span class="stage-name" data-idx="${idx}">${etapa.nome}</span>
      <button class="icon-btn" data-delete="${idx}">üóëÔ∏è</button>
    </div>
    <div class="progress" data-stage="${idx}" style="margin-bottom:12px">
      <div class="fill" style="width:${etapa.percentual}%"></div>
      <div class="pct-label">${etapa.percentual}%</div>
    </div>
    <div class="media-grid" data-media="${idx}"></div>
    <button class="btn" data-add-media="${idx}" style="width:100%;margin-top:8px">üì∑ + Adicionar M√≠dia</button>
  `;
  
  // Stage name click
  div.querySelector('.stage-name').addEventListener('click', () => {
    const newName = prompt('Nome da etapa:', etapa.nome);
    if (newName) {
      etapa.nome = newName;
      renderStages();
    }
  });
  
  // Delete stage
  div.querySelector('[data-delete]').addEventListener('click', () => {
    if (confirm(`Remover etapa "${etapa.nome}"?`)) {
      cronograma.etapas.splice(idx, 1);
      renderStages();
    }
  });
  
  // Progress click
  div.querySelector('.progress').addEventListener('click', () => {
    openSlider({
      title: `Progresso - ${etapa.nome}`,
      initial: etapa.percentual,
      onConfirm: (v) => {
        etapa.percentual = v;
        renderStages();
      }
    });
  });
  
  // Add media
  div.querySelector('[data-add-media]').addEventListener('click', () => {
    if (!etapa.media) etapa.media = [];
    etapa.media.push({ id: uid(), imagem_url: null, audio_url: null, nota: '' });
    renderStages();
  });
  
  // Render media
  const mediaContainer = div.querySelector('[data-media]');
  if (etapa.media && etapa.media.length > 0) {
    etapa.media.forEach((m, mIdx) => {
      mediaContainer.appendChild(createMediaElement(etapa, m, mIdx));
    });
  }
  
  return div;
}

function createMediaElement(etapa, media, mIdx) {
  const div = document.createElement('div');
  div.className = 'media-card';
  
  div.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span style="color:var(--muted);font-size:.85rem">M√≠dia ${mIdx + 1}</span>
      <button class="icon-btn" data-delete-media>üóëÔ∏è</button>
    </div>
    <div class="photo-box">
      ${media.imagem_url 
        ? `<img src="${media.imagem_url}" alt="Foto"/>`
        : `<div class="photo-hint"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.2A3.2 3.2 0 1 0 12 8.8a3.2 3.2 0 0 0 0 6.4z"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg><div>Toque para tirar foto</div></div>`
      }
    </div>
    <input type="file" accept="image/*" capture="environment" style="display:none" class="photo-input"/>
    <div class="rec-bar">
      <span class="timer">${media.audio_url ? '‚úì √Åudio' : 'REC'}</span>
      <button class="mic-btn">üéôÔ∏è</button>
    </div>
    ${media.audio_url ? `<audio class="audio-player" controls src="${media.audio_url}" preload="metadata"></audio>` : ''}
    <textarea class="note" placeholder="Nota/Resumo...">${media.nota || ''}</textarea>
  `;
  
  // Photo - usando abordagem mais leve para mobile
  const photoBox = div.querySelector('.photo-box');
  const photoInput = div.querySelector('.photo-input');
  
  photoBox.addEventListener('click', () => photoInput.click());
  
  photoInput.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    // Limpar input para liberar mem√≥ria
    e.target.value = '';
    
    toast('Comprimindo foto...');
    
    try {
      // Comprimir imagem (600px, qualidade 60%)
      const compressedFile = await compressImage(file, 600, 0.6);
      
      toast('Enviando...');
      
      const formData = new FormData();
      formData.append('file', compressedFile);
      formData.append('tipo', 'image');
      
      const res = await fetch(`${API_BASE}/supervisor/upload/media`, {
        method: 'POST',
        body: formData
      });
      
      if (!res.ok) throw new Error('Erro no servidor');
      
      const data = await res.json();
      media.imagem_url = data.url;
      renderStages();
      toast('Foto salva!');
    } catch (err) {
      console.error('Erro:', err);
      toast('Erro: ' + (err.message || 'Tente novamente'));
    }
  });
  
  // Audio - usando formato mais compat√≠vel
  const micBtn = div.querySelector('.mic-btn');
  const timerEl = div.querySelector('.timer');
  let mediaRecorder = null;
  let audioChunks = [];
  let recording = false;
  let startTime = 0;
  let timerInterval = null;
  let audioStream = null;
  
  micBtn.addEventListener('click', async () => {
    if (!recording) {
      try {
        audioStream = await navigator.mediaDevices.getUserMedia({ 
          audio: { 
            echoCancellation: true,
            noiseSuppression: true 
          } 
        });
        
        // Usar formato mais compat√≠vel
        const mimeType = MediaRecorder.isTypeSupported('audio/mp4') 
          ? 'audio/mp4' 
          : MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
            ? 'audio/webm;codecs=opus'
            : 'audio/webm';
        
        mediaRecorder = new MediaRecorder(audioStream, { mimeType });
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) audioChunks.push(e.data);
        };
        
        mediaRecorder.onstop = async () => {
          clearInterval(timerInterval);
          
          // Parar todas as tracks do stream
          audioStream.getTracks().forEach(track => track.stop());
          
          const audioBlob = new Blob(audioChunks, { type: mimeType });
          const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
          
          toast('Enviando √°udio...');
          
          try {
            const formData = new FormData();
            formData.append('file', audioBlob, `audio.${ext}`);
            formData.append('tipo', 'audio');
            
            const res = await fetch(`${API_BASE}/supervisor/upload/media`, {
              method: 'POST',
              body: formData
            });
            
            if (!res.ok) throw new Error('Erro no servidor');
            
            const data = await res.json();
            media.audio_url = data.url;
            renderStages();
            toast('√Åudio salvo!');
          } catch (err) {
            console.error('Erro √°udio:', err);
            toast('Erro ao enviar √°udio');
          }
        };
        
        mediaRecorder.start(1000); // Capturar em chunks de 1s
        recording = true;
        startTime = Date.now();
        micBtn.classList.add('recording');
        micBtn.textContent = '‚èπÔ∏è';
        
        timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const min = String(Math.floor(elapsed / 60)).padStart(2, '0');
          const sec = String(elapsed % 60).padStart(2, '0');
          timerEl.textContent = `${min}:${sec}`;
        }, 1000);
        
      } catch (err) {
        console.error('Erro microfone:', err);
        toast('Permita o acesso ao microfone');
      }
    } else {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
      recording = false;
      micBtn.classList.remove('recording');
      micBtn.textContent = 'üéôÔ∏è';
    }
  });
  
  // Note
  div.querySelector('.note').addEventListener('input', (e) => {
    media.nota = e.target.value;
  });
  
  // Delete media
  div.querySelector('[data-delete-media]').addEventListener('click', () => {
    if (confirm('Remover esta m√≠dia?')) {
      const idx = etapa.media.indexOf(media);
      if (idx > -1) etapa.media.splice(idx, 1);
      renderStages();
    }
  });
  
  return div;
}

// ===== Add Stage =====
document.getElementById('addStageBtn').addEventListener('click', addStage);
document.getElementById('fabAddStage').addEventListener('click', addStage);

function addStage() {
  const nome = prompt('Nome da etapa:', 'Nova Etapa');
  if (!nome) return;
  
  cronograma.etapas.push({
    id: uid(),
    nome: nome,
    percentual: 0,
    atualizado_em: new Date().toISOString(),
    media: []
  });
  
  renderStages();
}

// ===== Save =====
document.getElementById('saveBtn').addEventListener('click', async () => {
  if (!currentOrcamento) {
    toast('Selecione uma obra primeiro');
    return;
  }
  
  cronograma.projeto_nome = document.getElementById('projetoNome').value;
  
  try {
    const res = await fetch(`${API_BASE}/supervisor/${supervisor.id}/cronograma`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orcamento_id: currentOrcamento.id,
        data: cronograma.data,
        projeto_nome: cronograma.projeto_nome,
        progresso_geral: cronograma.progresso_geral,
        modo_progresso: cronograma.modo_progresso,
        etapas: cronograma.etapas
      })
    });
    
    const data = await res.json();
    cronograma.id = data.id;
    toast('Cronograma salvo!');
  } catch (err) {
    toast('Erro ao salvar');
  }
});

// ===== Send to Client =====
document.getElementById('sendClientBtn').addEventListener('click', async () => {
  if (!cronograma.id) {
    toast('Salve o cronograma primeiro');
    return;
  }
  
  try {
    const res = await fetch(`${API_BASE}/supervisor/${supervisor.id}/cronograma/${cronograma.id}/enviar`, {
      method: 'POST'
    });
    
    const data = await res.json();
    
    if (data.whatsapp_url) {
      window.open(data.whatsapp_url, '_blank');
      toast('Abrindo WhatsApp...');
    } else {
      toast('Erro: Cliente sem WhatsApp');
    }
  } catch (err) {
    toast('Erro ao enviar');
  }
});

// ===== Init =====
checkStoredLogin();
</script>
</body>
</html>
