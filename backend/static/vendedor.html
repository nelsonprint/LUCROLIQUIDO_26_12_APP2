<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<meta name="theme-color" content="#FF7A00"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Vendedor"/>
<link rel="manifest" href="/api/vendedor/manifest.json"/>
<title>App do Vendedor - Lucro L√≠quido</title>
<style>
:root{--brand:#FF7A00;--brand-rgb:255,122,0;--bg:#0f0f10;--card:#16171a;--muted:#9aa0a6;--text:#e8eaed;--border:#2a2d33;--danger:#ff5964;--success:#22c55e}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif}
body{padding-bottom:80px}

.install-banner{display:none;position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#FF7A00,#FF5500);color:#fff;padding:12px;z-index:10000;text-align:center}
.install-banner.show{display:flex;align-items:center;justify-content:center;gap:12px}
.install-banner button{background:#fff;color:#FF7A00;border:none;padding:8px 16px;border-radius:8px;font-weight:700;cursor:pointer}
.install-banner .close{background:transparent;color:#fff;font-size:1.2rem}

.login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.login-screen.hidden{display:none}
.login-box{background:var(--card);border-radius:16px;padding:32px;width:100%;max-width:400px;text-align:center}
.login-box h1{font-size:1.5rem;margin-bottom:8px;color:var(--brand)}
.login-box p{color:var(--muted);margin-bottom:24px}
.login-box .input{width:100%;padding:14px;border-radius:10px;border:1px solid var(--border);background:#0e0f12;color:var(--text);font-size:1rem;margin-bottom:12px}
.login-box .btn{width:100%;padding:14px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-size:1rem;font-weight:700;cursor:pointer}
.login-box .error{color:var(--danger);margin-top:12px;font-size:.9rem}

.app-screen{display:none}
.app-screen.show{display:block}

.container{max-width:1100px;margin:0 auto;padding:12px 8px}

.header{background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px;position:sticky;top:0;z-index:100}
.header-content{display:flex;align-items:center;justify-content:space-between;max-width:1100px;margin:0 auto}
.header h1{font-size:1.1rem;color:var(--brand)}
.header .user-info{font-size:.85rem;color:var(--muted)}
.header .logout-btn{background:transparent;border:1px solid var(--danger);color:var(--danger);padding:6px 12px;border-radius:6px;cursor:pointer}

.card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:12px}
.card-title{font-size:1rem;font-weight:700;margin-bottom:12px;color:var(--brand)}

.label{font-size:.85rem;color:var(--muted);margin-bottom:6px;display:block}
.input,.select{width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);background:#0e0f12;color:var(--text);font-size:1rem}
.btn{padding:12px 16px;border:1px solid var(--border);background:#0e0f12;color:var(--text);border-radius:8px;cursor:pointer;font-weight:600}
.btn-primary{border-color:var(--brand);background:var(--brand);color:#fff}
.btn-success{border-color:var(--success);background:var(--success);color:#fff}
.btn-danger{border-color:var(--danger);color:var(--danger)}
.btn-ghost{background:transparent;border:1px dashed var(--border)}
.btn-sm{padding:6px 10px;font-size:.85rem}

.kpis{display:grid;gap:10px;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));margin-bottom:16px}
.kpi{background:#1a1b1f;padding:14px;border-radius:10px;text-align:center;border:1px solid var(--border)}
.kpi .label{font-size:.75rem;color:var(--muted);margin-bottom:4px}
.kpi .value{font-size:1.3rem;font-weight:800;color:var(--brand)}
.kpi.success .value{color:var(--success)}
.kpi.danger .value{color:var(--danger)}

.nav-tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.nav-tab{flex:1;min-width:100px;padding:12px;text-align:center;border-radius:10px;background:#1a1b1f;color:var(--muted);border:1px solid var(--border);cursor:pointer;font-weight:600}
.nav-tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

.list-item{background:#1a1b1f;border-radius:10px;padding:12px;margin-bottom:8px;border-left:3px solid var(--brand);display:flex;justify-content:space-between;align-items:center;gap:12px}
.list-item .info{flex:1}
.list-item .title{font-weight:700;margin-bottom:4px}
.list-item .subtitle{font-size:.85rem;color:var(--muted)}
.list-item .badge{padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:700}
.list-item .actions{display:flex;gap:6px;align-items:center}
.badge-pendente{background:#fef3c7;color:#92400e}
.badge-aprovado{background:#d1fae5;color:#065f46}
.badge-enviado{background:#dbeafe;color:#1e40af}
.badge-rascunho{background:#f3f4f6;color:#374151}
.badge-pago{background:#d1fae5;color:#065f46}
.badge-confirmado{background:#dbeafe;color:#1e40af}
.badge-concluido{background:#d1fae5;color:#065f46}
.badge-cancelado{background:#fee2e2;color:#991b1b}

.empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
.empty-state svg{width:60px;height:60px;margin-bottom:12px;opacity:.5}

.form-group{margin-bottom:16px}
.form-row{display:grid;gap:12px;grid-template-columns:1fr}
@media (min-width:500px){.form-row.cols-2{grid-template-columns:1fr 1fr}.form-row.cols-3{grid-template-columns:1fr 1fr 1fr}}

.action-bar{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);padding:12px;display:flex;gap:10px;justify-content:center}
.action-btn{flex:1;max-width:200px;padding:14px;border-radius:12px;border:none;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
.action-btn.primary{background:var(--brand);color:#fff}
.action-btn.secondary{background:#1a1b1f;color:var(--text);border:1px solid var(--border)}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal.show{display:flex}
.modal-content{background:var(--card);border-radius:16px;padding:20px;width:100%;max-width:500px;max-height:85vh;overflow-y:auto}
.modal-content.large{max-width:600px}
.modal-title{font-size:1.2rem;font-weight:700;margin-bottom:16px;color:var(--brand)}
.modal-actions{display:flex;gap:10px;margin-top:16px}
.modal-actions .btn{flex:1}

.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 24px;border-radius:8px;z-index:10001;display:none}
.toast.show{display:block}

/* Tabs para tipo de cliente */
.tipo-tabs{display:flex;gap:8px;margin-bottom:16px}
.tipo-tab{flex:1;padding:10px;text-align:center;border-radius:8px;background:#1a1b1f;color:var(--muted);border:1px solid var(--border);cursor:pointer;font-weight:600}
.tipo-tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

/* Se√ß√µes colaps√°veis */
.section-title{font-size:.9rem;font-weight:700;color:var(--brand);margin:16px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)}

/* Photo/Audio capture */
.media-capture{background:#1a1b1f;border-radius:10px;padding:12px;margin-top:10px}
.photo-box{position:relative;min-height:180px;border-radius:8px;background:#2a2d33;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer}
.photo-box img{width:100%;height:100%;object-fit:cover}
.photo-hint{color:var(--muted);text-align:center;padding:20px}

.item-card{background:#0e0f12;border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid var(--border)}
.item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.item-number{background:var(--brand);color:#fff;padding:4px 10px;border-radius:6px;font-weight:700;font-size:.85rem}
.remove-item{background:transparent;border:1px solid var(--danger);color:var(--danger);width:32px;height:32px;border-radius:6px;cursor:pointer}

.edit-btn{background:var(--brand);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:.8rem}
.delete-btn{background:transparent;border:1px solid var(--danger);color:var(--danger);padding:6px 10px;border-radius:6px;cursor:pointer;font-size:.8rem}

/* Cliente select com bot√£o de adicionar */
.select-with-add{display:flex;gap:8px}
.select-with-add select{flex:1}
.add-btn{background:var(--brand);color:#fff;border:none;width:44px;border-radius:8px;cursor:pointer;font-size:1.2rem;font-weight:700}
</style>
</head>
<body>

<div id="installBanner" class="install-banner">
  <span>üì≤ Instale o App</span>
  <button id="installBtn">Instalar</button>
  <button class="close" id="closeBanner">√ó</button>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <h1>üõí App do Vendedor</h1>
    <p>Gerencie seus or√ßamentos e comiss√µes</p>
    <input type="email" id="loginEmail" class="input" placeholder="Email"/>
    <input type="password" id="loginSenha" class="input" placeholder="Senha"/>
    <button id="loginBtn" class="btn btn-primary">Entrar</button>
    <div id="loginError" class="error"></div>
    
    <!-- Bot√£o de instala√ß√£o manual -->
    <div id="installSection" style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
      <button id="installBtnManual" class="btn" style="width:100%;background:#1a1b1f;border:1px dashed var(--brand);color:var(--brand)">
        üì≤ Instalar App no Celular
      </button>
      <p id="installInstructions" style="display:none;margin-top:12px;font-size:.8rem;color:var(--muted);text-align:left;background:#1a1b1f;padding:12px;border-radius:8px">
        <strong style="color:var(--brand)">Como instalar:</strong><br><br>
        <strong>iPhone/iPad (Safari):</strong><br>
        1. Toque no bot√£o compartilhar (‚¨ÜÔ∏è)<br>
        2. Role e toque em "Adicionar √† Tela de In√≠cio"<br><br>
        <strong>Android (Chrome):</strong><br>
        1. Toque no menu (‚ãÆ) no canto superior<br>
        2. Toque em "Instalar app" ou "Adicionar √† tela inicial"
      </p>
    </div>
  </div>
</div>

<!-- APP SCREEN -->
<div id="appScreen" class="app-screen">
  <header class="header">
    <div class="header-content">
      <div>
        <h1>üõí App do Vendedor</h1>
        <span id="vendedorNome" class="user-info">Carregando...</span>
      </div>
      <button id="logoutBtn" class="logout-btn">Sair</button>
    </div>
  </header>

  <main class="container">
    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi success"><div class="label">Comiss√£o Liberada</div><div id="kpiLiberada" class="value">R$ 0,00</div></div>
      <div class="kpi"><div class="label">Comiss√£o Pendente</div><div id="kpiPendente" class="value">R$ 0,00</div></div>
      <div class="kpi"><div class="label">Total Or√ßamentos</div><div id="kpiOrcamentos" class="value">0</div></div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <div class="nav-tab active" data-tab="orcamentos">üìÑ Or√ßamentos</div>
      <div class="nav-tab" data-tab="comissoes">üí∞ Comiss√µes</div>
      <div class="nav-tab" data-tab="agenda">üìÖ Agenda</div>
    </div>

    <!-- Tab: Or√ßamentos -->
    <div id="tabOrcamentos" class="tab-content">
      <div class="card">
        <div class="card-title">Meus Or√ßamentos</div>
        <div id="listaOrcamentos"></div>
      </div>
    </div>

    <!-- Tab: Comiss√µes -->
    <div id="tabComissoes" class="tab-content" style="display:none">
      <div class="card">
        <div class="card-title">Minhas Comiss√µes</div>
        <div id="listaComissoes"></div>
      </div>
    </div>

    <!-- Tab: Agenda -->
    <div id="tabAgenda" class="tab-content" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div class="card-title" style="margin:0">Agenda de Visitas</div>
          <button id="btnNovaVisita" class="btn btn-primary" style="padding:8px 12px">+ Nova</button>
        </div>
        <div id="listaAgenda"></div>
      </div>
    </div>
  </main>

  <!-- Action Bar -->
  <div class="action-bar">
    <button id="btnNovoPreOrcamento" class="action-btn primary">üìù Novo Pr√©-Or√ßamento</button>
  </div>
</div>

<!-- Modal: Pr√©-Or√ßamento -->
<div id="modalPreOrcamento" class="modal">
  <div class="modal-content large">
    <div class="modal-title">üìù Novo Pr√©-Or√ßamento</div>
    
    <div class="form-group">
      <label class="label">Cliente / Prospect</label>
      <div class="select-with-add">
        <select id="preCliente" class="select"></select>
        <button type="button" class="add-btn" onclick="abrirModalNovoCliente()">+</button>
      </div>
    </div>
    
    <div class="form-group">
      <label class="label">Data Entrega</label>
      <input type="date" id="preDataEntrega" class="input"/>
    </div>
    
    <div class="form-group">
      <label class="label">Itens do Pr√©-Or√ßamento</label>
      <div id="preItens"></div>
      <button id="btnAddItem" class="btn btn-ghost" style="width:100%;margin-top:10px">+ Adicionar Item</button>
    </div>
    
    <div class="form-group">
      <label class="label">Observa√ß√µes</label>
      <textarea id="preObs" class="input" rows="3" placeholder="Observa√ß√µes gerais..."></textarea>
    </div>
    
    <div class="modal-actions">
      <button id="btnCancelarPre" class="btn">Cancelar</button>
      <button id="btnSalvarPre" class="btn btn-primary">Salvar</button>
    </div>
  </div>
</div>

<!-- Modal: Nova/Editar Visita -->
<div id="modalVisita" class="modal">
  <div class="modal-content">
    <div class="modal-title" id="modalVisitaTitulo">üìÖ Nova Visita</div>
    <input type="hidden" id="visitaId"/>
    
    <div class="form-group">
      <label class="label">Cliente</label>
      <div class="select-with-add">
        <select id="visitaCliente" class="select"></select>
        <button type="button" class="add-btn" onclick="abrirModalNovoCliente()">+</button>
      </div>
    </div>
    
    <div class="form-group">
      <label class="label">T√≠tulo</label>
      <input type="text" id="visitaTitulo" class="input" placeholder="Ex: Visita t√©cnica"/>
    </div>
    
    <div class="form-row cols-2">
      <div class="form-group">
        <label class="label">Data</label>
        <input type="date" id="visitaData" class="input"/>
      </div>
      <div class="form-group">
        <label class="label">Hora</label>
        <input type="time" id="visitaHora" class="input"/>
      </div>
    </div>
    
    <div class="form-group">
      <label class="label">Status</label>
      <select id="visitaStatus" class="select">
        <option value="Pendente">Pendente</option>
        <option value="Confirmado">Confirmado</option>
        <option value="Reagendado">Reagendado</option>
        <option value="Conclu√≠do">Conclu√≠do</option>
        <option value="Cancelado">Cancelado</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="label">Descri√ß√£o</label>
      <textarea id="visitaDesc" class="input" rows="2" placeholder="Detalhes da visita..."></textarea>
    </div>
    
    <div class="modal-actions">
      <button id="btnCancelarVisita" class="btn">Cancelar</button>
      <button id="btnExcluirVisita" class="btn btn-danger" style="display:none">Excluir</button>
      <button id="btnSalvarVisita" class="btn btn-primary">Salvar</button>
    </div>
  </div>
</div>

<!-- Modal: Novo Cliente/Prospect -->
<div id="modalNovoCliente" class="modal">
  <div class="modal-content large">
    <div class="modal-title">üë§ Novo Cliente / Prospect</div>
    
    <div class="tipo-tabs">
      <div class="tipo-tab active" data-tipo="PF" onclick="selecionarTipoCliente('PF')">Pessoa F√≠sica</div>
      <div class="tipo-tab" data-tipo="PJ" onclick="selecionarTipoCliente('PJ')">Pessoa Jur√≠dica</div>
    </div>
    
    <input type="hidden" id="clienteTipo" value="PF"/>
    
    <!-- Campos Pessoa F√≠sica -->
    <div id="camposPF">
      <div class="section-title">üìã Dados Pessoais</div>
      <div class="form-group">
        <label class="label">Nome Completo *</label>
        <input type="text" id="clienteNome" class="input" placeholder="Nome completo"/>
      </div>
      <div class="form-row cols-2">
        <div class="form-group">
          <label class="label">CPF</label>
          <input type="text" id="clienteCpf" class="input" placeholder="000.000.000-00"/>
        </div>
        <div class="form-group">
          <label class="label">Sexo</label>
          <select id="clienteSexo" class="select">
            <option value="">Selecione...</option>
            <option value="Masculino">Masculino</option>
            <option value="Feminino">Feminino</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="label">Profiss√£o</label>
        <input type="text" id="clienteProfissao" class="input" placeholder="Profiss√£o"/>
      </div>
    </div>
    
    <!-- Campos Pessoa Jur√≠dica -->
    <div id="camposPJ" style="display:none">
      <div class="section-title">üè¢ Dados da Empresa</div>
      <div class="form-group">
        <label class="label">Nome Fantasia *</label>
        <input type="text" id="clienteNomeFantasia" class="input" placeholder="Nome fantasia"/>
      </div>
      <div class="form-group">
        <label class="label">Raz√£o Social</label>
        <input type="text" id="clienteRazaoSocial" class="input" placeholder="Raz√£o social"/>
      </div>
      <div class="form-row cols-2">
        <div class="form-group">
          <label class="label">CNPJ</label>
          <input type="text" id="clienteCnpj" class="input" placeholder="00.000.000/0000-00"/>
        </div>
        <div class="form-group">
          <label class="label">Ramo de Atua√ß√£o</label>
          <input type="text" id="clienteRamo" class="input" placeholder="Ramo"/>
        </div>
      </div>
      <div class="form-row cols-2">
        <div class="form-group">
          <label class="label">Inscri√ß√£o Municipal</label>
          <input type="text" id="clienteInscMunicipal" class="input" placeholder="Inscri√ß√£o municipal"/>
        </div>
        <div class="form-group">
          <label class="label">Inscri√ß√£o Estadual</label>
          <input type="text" id="clienteInscEstadual" class="input" placeholder="Inscri√ß√£o estadual"/>
        </div>
      </div>
      <div class="form-group">
        <label class="label">Site</label>
        <input type="url" id="clienteSite" class="input" placeholder="https://"/>
      </div>
      
      <div class="section-title">üíº Contato Financeiro</div>
      <div class="form-group">
        <label class="label">Nome do Contato</label>
        <input type="text" id="clienteContatoFinanceiroNome" class="input" placeholder="Nome"/>
      </div>
      <div class="form-row cols-2">
        <div class="form-group">
          <label class="label">WhatsApp</label>
          <input type="tel" id="clienteContatoFinanceiroWhatsapp" class="input" placeholder="(00) 00000-0000"/>
        </div>
        <div class="form-group">
          <label class="label">Email</label>
          <input type="email" id="clienteContatoFinanceiroEmail" class="input" placeholder="email@empresa.com"/>
        </div>
      </div>
    </div>
    
    <!-- Campos Comuns: Endere√ßo -->
    <div class="section-title">üìç Endere√ßo</div>
    <div class="form-row cols-2">
      <div class="form-group">
        <label class="label">CEP</label>
        <input type="text" id="clienteCep" class="input" placeholder="00000-000" onblur="buscarCep()"/>
      </div>
      <div class="form-group">
        <label class="label">Logradouro</label>
        <input type="text" id="clienteLogradouro" class="input" placeholder="Rua, Avenida..."/>
      </div>
    </div>
    <div class="form-row cols-3">
      <div class="form-group">
        <label class="label">N√∫mero</label>
        <input type="text" id="clienteNumero" class="input" placeholder="N¬∫"/>
      </div>
      <div class="form-group">
        <label class="label">Complemento</label>
        <input type="text" id="clienteComplemento" class="input" placeholder="Apto, Sala..."/>
      </div>
      <div class="form-group">
        <label class="label">Bairro</label>
        <input type="text" id="clienteBairro" class="input" placeholder="Bairro"/>
      </div>
    </div>
    <div class="form-row cols-2">
      <div class="form-group">
        <label class="label">Cidade</label>
        <input type="text" id="clienteCidade" class="input" placeholder="Cidade"/>
      </div>
      <div class="form-group">
        <label class="label">Estado</label>
        <select id="clienteEstado" class="select">
          <option value="">Selecione...</option>
          <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option>
          <option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option>
          <option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option>
          <option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
          <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option>
          <option value="PR">PR</option><option value="PE">PE</option><option value="PI">PI</option>
          <option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option>
          <option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
          <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="label">Ponto de Refer√™ncia</label>
      <input type="text" id="clientePontoRef" class="input" placeholder="Ponto de refer√™ncia"/>
    </div>
    
    <!-- Campos Comuns: Contato -->
    <div class="section-title">üìû Contato</div>
    <div class="form-row cols-2">
      <div class="form-group">
        <label class="label">WhatsApp *</label>
        <input type="tel" id="clienteWhatsapp" class="input" placeholder="(00) 00000-0000"/>
      </div>
      <div class="form-group">
        <label class="label">Telefone Fixo</label>
        <input type="tel" id="clienteTelefone" class="input" placeholder="(00) 0000-0000"/>
      </div>
    </div>
    <div class="form-group">
      <label class="label">Email</label>
      <input type="email" id="clienteEmail" class="input" placeholder="email@exemplo.com"/>
    </div>
    
    <div class="modal-actions">
      <button id="btnCancelarCliente" class="btn" onclick="fecharModalNovoCliente()">Cancelar</button>
      <button id="btnSalvarCliente" class="btn btn-primary" onclick="salvarNovoCliente()">Salvar Cliente</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
const API_BASE = window.location.origin + '/api';
let vendedor = null;
let empresa = null;
let clientes = [];
let agendas = [];

// ===== Utils =====
const fmtBRL = v => new Intl.NumberFormat('pt-BR', {style:'currency',currency:'BRL'}).format(v||0);
const fmtData = d => d ? new Date(d+'T12:00:00').toLocaleDateString('pt-BR') : '-';
const showToast = msg => { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); };

// M√°scaras
const maskCpf = v => v.replace(/\D/g,'').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2').slice(0,14);
const maskCnpj = v => v.replace(/\D/g,'').replace(/(\d{2})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1/$2').replace(/(\d{4})(\d{1,2})$/,'$1-$2').slice(0,18);
const maskPhone = v => v.replace(/\D/g,'').replace(/(\d{2})(\d)/,'($1) $2').replace(/(\d{5})(\d{4})$/,'$1-$2').slice(0,15);
const maskCep = v => v.replace(/\D/g,'').replace(/(\d{5})(\d)/,'$1-$2').slice(0,9);

// ===== PWA Install =====
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBanner').classList.add('show'); });
document.getElementById('installBtn').onclick = async () => { if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; document.getElementById('installBanner').classList.remove('show'); } };
document.getElementById('closeBanner').onclick = () => document.getElementById('installBanner').classList.remove('show');

// ===== Login =====
document.getElementById('loginBtn').onclick = async () => {
  const email = document.getElementById('loginEmail').value;
  const senha = document.getElementById('loginSenha').value;
  const err = document.getElementById('loginError');
  if (!email || !senha) { err.textContent = 'Preencha todos os campos'; return; }
  
  try {
    const res = await fetch(API_BASE + '/vendedor/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ login_email: email, login_senha: senha })
    });
    
    if (!res.ok) {
      const data = await res.json();
      err.textContent = data.detail || 'Credenciais inv√°lidas';
      return;
    }
    
    const data = await res.json();
    vendedor = data.vendedor;
    empresa = data.empresa;
    
    localStorage.setItem('vendedor', JSON.stringify(vendedor));
    localStorage.setItem('empresa', JSON.stringify(empresa));
    
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('appScreen').classList.add('show');
    document.getElementById('vendedorNome').textContent = vendedor.nome_completo;
    
    await loadClientes();
    await loadOrcamentos();
    await loadComissoes();
    await loadAgenda();
  } catch (e) {
    err.textContent = 'Erro de conex√£o';
  }
};

// ===== Logout =====
document.getElementById('logoutBtn').onclick = () => {
  vendedor = null;
  empresa = null;
  localStorage.removeItem('vendedor');
  localStorage.removeItem('empresa');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('appScreen').classList.remove('show');
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginSenha').value = '';
  document.getElementById('loginError').textContent = '';
};

// ===== Tabs =====
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.getElementById('tab' + tab.dataset.tab.charAt(0).toUpperCase() + tab.dataset.tab.slice(1)).style.display = 'block';
  };
});

// ===== Load Clientes =====
async function loadClientes() {
  try {
    const res = await fetch(API_BASE + '/clientes/' + empresa.id);
    clientes = await res.json();
    atualizarSelectClientes();
  } catch (e) { console.error('Erro ao carregar clientes:', e); }
}

function atualizarSelectClientes() {
  const opts = clientes.map(c => `<option value="${c.id}">${c.nome || c.nome_fantasia || c.razao_social}</option>`).join('');
  document.getElementById('preCliente').innerHTML = '<option value="">Selecione...</option>' + opts;
  document.getElementById('visitaCliente').innerHTML = '<option value="">Selecione...</option>' + opts;
}

// ===== Load Or√ßamentos =====
async function loadOrcamentos() {
  try {
    const res = await fetch(API_BASE + '/vendedor/' + vendedor.id + '/orcamentos');
    const orcamentos = await res.json();
    
    document.getElementById('kpiOrcamentos').textContent = orcamentos.length;
    
    const lista = document.getElementById('listaOrcamentos');
    if (orcamentos.length === 0) {
      lista.innerHTML = '<div class="empty-state"><p>Nenhum or√ßamento encontrado</p></div>';
      return;
    }
    
    lista.innerHTML = orcamentos.map(o => {
      const status = o.status || 'RASCUNHO';
      const badgeClass = {
        'RASCUNHO': 'badge-rascunho',
        'ENVIADO': 'badge-enviado',
        'APROVADO': 'badge-aprovado',
        'NAO_APROVADO': 'badge-pendente'
      }[status] || 'badge-rascunho';
      
      return `
        <div class="list-item">
          <div class="info">
            <div class="title">#${o.numero_orcamento || '-'} - ${o.cliente_nome}</div>
            <div class="subtitle">${fmtData(o.created_at?.split('T')[0])} ‚Ä¢ ${fmtBRL(o.preco_praticado)}</div>
          </div>
          <span class="badge ${badgeClass}">${status}</span>
        </div>
      `;
    }).join('');
  } catch (e) { console.error('Erro ao carregar or√ßamentos:', e); }
}

// ===== Load Comiss√µes =====
async function loadComissoes() {
  try {
    const res = await fetch(API_BASE + '/vendedor/' + vendedor.id + '/comissoes');
    const data = await res.json();
    
    document.getElementById('kpiLiberada').textContent = fmtBRL(data.total_pago);
    document.getElementById('kpiPendente').textContent = fmtBRL(data.total_pendente);
    
    const lista = document.getElementById('listaComissoes');
    if (data.comissoes.length === 0) {
      lista.innerHTML = '<div class="empty-state"><p>Nenhuma comiss√£o encontrada</p></div>';
      return;
    }
    
    lista.innerHTML = data.comissoes.map(c => {
      const isPago = c.status === 'PAGO';
      return `
        <div class="list-item">
          <div class="info">
            <div class="title">${c.descricao}</div>
            <div class="subtitle">Venc: ${fmtData(c.data_vencimento)} ‚Ä¢ Base: ${fmtBRL(c.valor_base_servicos || c.valor_base || 0)}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700;color:${isPago ? 'var(--success)' : 'var(--brand)'}">${fmtBRL(c.valor)}</div>
            <span class="badge ${isPago ? 'badge-pago' : 'badge-pendente'}">${isPago ? 'PAGO' : 'PENDENTE'}</span>
          </div>
        </div>
      `;
    }).join('');
  } catch (e) { console.error('Erro ao carregar comiss√µes:', e); }
}

// ===== Load Agenda =====
async function loadAgenda() {
  try {
    const res = await fetch(API_BASE + '/vendedor/' + vendedor.id + '/agenda');
    agendas = await res.json();
    
    const lista = document.getElementById('listaAgenda');
    if (agendas.length === 0) {
      lista.innerHTML = '<div class="empty-state"><p>Nenhuma visita agendada</p></div>';
      return;
    }
    
    lista.innerHTML = agendas.map(a => {
      const statusClass = {
        'Pendente': 'badge-pendente',
        'Confirmado': 'badge-confirmado',
        'Conclu√≠do': 'badge-concluido',
        'Cancelado': 'badge-cancelado',
        'Reagendado': 'badge-enviado'
      }[a.status] || 'badge-pendente';
      
      return `
        <div class="list-item">
          <div class="info">
            <div class="title">${a.titulo}</div>
            <div class="subtitle">${a.cliente_nome} ‚Ä¢ ${fmtData(a.data)} ${a.hora_inicio || ''}</div>
          </div>
          <div class="actions">
            <span class="badge ${statusClass}">${a.status}</span>
            <button class="edit-btn" onclick="editarAgenda('${a.id}')">‚úèÔ∏è</button>
          </div>
        </div>
      `;
    }).join('');
  } catch (e) { console.error('Erro ao carregar agenda:', e); }
}

// ===== Editar Agenda =====
function editarAgenda(agendaId) {
  const agenda = agendas.find(a => a.id === agendaId);
  if (!agenda) return;
  
  document.getElementById('modalVisitaTitulo').textContent = 'üìÖ Editar Visita';
  document.getElementById('visitaId').value = agenda.id;
  document.getElementById('visitaCliente').value = agenda.cliente_id || '';
  document.getElementById('visitaTitulo').value = agenda.titulo || '';
  document.getElementById('visitaData').value = agenda.data || '';
  document.getElementById('visitaHora').value = agenda.hora_inicio || '';
  document.getElementById('visitaStatus').value = agenda.status || 'Pendente';
  document.getElementById('visitaDesc').value = agenda.descricao || '';
  document.getElementById('btnExcluirVisita').style.display = 'block';
  document.getElementById('modalVisita').classList.add('show');
}

// ===== Pr√©-Or√ßamento =====
let preItensCount = 0;

document.getElementById('btnNovoPreOrcamento').onclick = () => {
  preItensCount = 0;
  document.getElementById('preItens').innerHTML = '';
  document.getElementById('preDataEntrega').value = '';
  document.getElementById('preObs').value = '';
  document.getElementById('preCliente').value = '';
  addPreItem();
  document.getElementById('modalPreOrcamento').classList.add('show');
};

document.getElementById('btnAddItem').onclick = addPreItem;

function addPreItem() {
  preItensCount++;
  const div = document.createElement('div');
  div.className = 'item-card';
  div.id = 'preItem' + preItensCount;
  div.innerHTML = `
    <div class="item-header">
      <span class="item-number">Item ${String(preItensCount).padStart(3, '0')}</span>
      <button class="remove-item" onclick="this.parentElement.parentElement.remove()">√ó</button>
    </div>
    <div class="form-group">
      <label class="label">Descri√ß√£o (at√© 125 caracteres)</label>
      <textarea class="input item-desc" maxlength="125" rows="2" placeholder="Descreva o servi√ßo..."></textarea>
    </div>
    <div class="form-row cols-2">
      <div class="form-group">
        <label class="label">Quantidade</label>
        <input type="number" class="input item-qtd" value="1" min="1"/>
      </div>
      <div class="form-group">
        <label class="label">Foto</label>
        <div class="photo-box" onclick="capturePhoto(this)">
          <div class="photo-hint">üì∑ Tirar Foto</div>
        </div>
        <input type="hidden" class="item-foto"/>
      </div>
    </div>
  `;
  document.getElementById('preItens').appendChild(div);
}

async function capturePhoto(box) {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    const video = document.createElement('video');
    video.autoplay = true;
    video.playsInline = true;
    video.srcObject = stream;
    
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:#000;z-index:9999;display:flex;flex-direction:column';
    video.style.cssText = 'flex:1;object-fit:cover';
    
    const controls = document.createElement('div');
    controls.style.cssText = 'padding:20px;display:flex;gap:10px;justify-content:center';
    
    const btnCapture = document.createElement('button');
    btnCapture.className = 'btn btn-primary';
    btnCapture.textContent = 'üì∏ Capturar';
    
    const btnCancel = document.createElement('button');
    btnCancel.className = 'btn';
    btnCancel.textContent = 'Cancelar';
    
    controls.appendChild(btnCapture);
    controls.appendChild(btnCancel);
    modal.appendChild(video);
    modal.appendChild(controls);
    document.body.appendChild(modal);
    
    await video.play();
    
    btnCancel.onclick = () => { stream.getTracks().forEach(t => t.stop()); modal.remove(); };
    
    btnCapture.onclick = () => {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      
      stream.getTracks().forEach(t => t.stop());
      modal.remove();
      
      box.innerHTML = `<img src="${dataUrl}" alt="Foto"/>`;
      box.parentElement.querySelector('.item-foto').value = dataUrl;
    };
  } catch (e) {
    showToast('Erro ao acessar c√¢mera');
  }
}

document.getElementById('btnCancelarPre').onclick = () => document.getElementById('modalPreOrcamento').classList.remove('show');

document.getElementById('btnSalvarPre').onclick = async () => {
  const clienteId = document.getElementById('preCliente').value;
  if (!clienteId) { showToast('Selecione um cliente'); return; }
  
  const cliente = clientes.find(c => c.id === clienteId);
  const itens = [...document.querySelectorAll('.item-card')].map(card => ({
    descricao: card.querySelector('.item-desc').value,
    quantidade: parseInt(card.querySelector('.item-qtd').value) || 1,
    foto_url: card.querySelector('.item-foto').value || null
  })).filter(i => i.descricao);
  
  if (itens.length === 0) { showToast('Adicione pelo menos um item'); return; }
  
  try {
    const res = await fetch(API_BASE + '/vendedor/' + vendedor.id + '/pre-orcamento', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        empresa_id: empresa.id,
        cliente_id: clienteId,
        cliente_nome: cliente.nome || cliente.nome_fantasia || cliente.razao_social,
        cliente_whatsapp: cliente.whatsapp,
        data_entrega: document.getElementById('preDataEntrega').value,
        itens,
        observacoes: document.getElementById('preObs').value
      })
    });
    
    if (res.ok) {
      showToast('Pr√©-or√ßamento salvo!');
      document.getElementById('modalPreOrcamento').classList.remove('show');
    } else {
      showToast('Erro ao salvar');
    }
  } catch (e) {
    showToast('Erro de conex√£o');
  }
};

// ===== Nova Visita =====
document.getElementById('btnNovaVisita').onclick = () => {
  document.getElementById('modalVisitaTitulo').textContent = 'üìÖ Nova Visita';
  document.getElementById('visitaId').value = '';
  document.getElementById('visitaTitulo').value = '';
  document.getElementById('visitaData').value = '';
  document.getElementById('visitaHora').value = '';
  document.getElementById('visitaStatus').value = 'Pendente';
  document.getElementById('visitaDesc').value = '';
  document.getElementById('visitaCliente').value = '';
  document.getElementById('btnExcluirVisita').style.display = 'none';
  document.getElementById('modalVisita').classList.add('show');
};

document.getElementById('btnCancelarVisita').onclick = () => document.getElementById('modalVisita').classList.remove('show');

document.getElementById('btnSalvarVisita').onclick = async () => {
  const agendaId = document.getElementById('visitaId').value;
  const clienteId = document.getElementById('visitaCliente').value;
  const titulo = document.getElementById('visitaTitulo').value;
  const data = document.getElementById('visitaData').value;
  
  if (!clienteId || !titulo || !data) { showToast('Preencha os campos obrigat√≥rios'); return; }
  
  const cliente = clientes.find(c => c.id === clienteId);
  const payload = {
    empresa_id: empresa.id,
    cliente_id: clienteId,
    cliente_nome: cliente.nome || cliente.nome_fantasia || cliente.razao_social,
    titulo,
    descricao: document.getElementById('visitaDesc').value,
    data,
    hora_inicio: document.getElementById('visitaHora').value,
    hora_fim: '',
    status: document.getElementById('visitaStatus').value
  };
  
  try {
    const url = agendaId 
      ? `${API_BASE}/vendedor/${vendedor.id}/agenda/${agendaId}`
      : `${API_BASE}/vendedor/${vendedor.id}/agenda`;
    const method = agendaId ? 'PUT' : 'POST';
    
    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (res.ok) {
      showToast(agendaId ? 'Visita atualizada!' : 'Visita agendada!');
      document.getElementById('modalVisita').classList.remove('show');
      await loadAgenda();
    } else {
      showToast('Erro ao salvar');
    }
  } catch (e) {
    showToast('Erro de conex√£o');
  }
};

document.getElementById('btnExcluirVisita').onclick = async () => {
  const agendaId = document.getElementById('visitaId').value;
  if (!agendaId) return;
  
  if (!confirm('Deseja realmente excluir esta visita?')) return;
  
  try {
    const res = await fetch(`${API_BASE}/vendedor/${vendedor.id}/agenda/${agendaId}`, { method: 'DELETE' });
    if (res.ok) {
      showToast('Visita exclu√≠da!');
      document.getElementById('modalVisita').classList.remove('show');
      await loadAgenda();
    } else {
      showToast('Erro ao excluir');
    }
  } catch (e) {
    showToast('Erro de conex√£o');
  }
};

// ===== Novo Cliente/Prospect =====
function abrirModalNovoCliente() {
  limparFormCliente();
  document.getElementById('modalNovoCliente').classList.add('show');
}

function fecharModalNovoCliente() {
  document.getElementById('modalNovoCliente').classList.remove('show');
}

function selecionarTipoCliente(tipo) {
  document.querySelectorAll('.tipo-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tipo-tab[data-tipo="${tipo}"]`).classList.add('active');
  document.getElementById('clienteTipo').value = tipo;
  document.getElementById('camposPF').style.display = tipo === 'PF' ? 'block' : 'none';
  document.getElementById('camposPJ').style.display = tipo === 'PJ' ? 'block' : 'none';
}

function limparFormCliente() {
  selecionarTipoCliente('PF');
  // PF
  document.getElementById('clienteNome').value = '';
  document.getElementById('clienteCpf').value = '';
  document.getElementById('clienteSexo').value = '';
  document.getElementById('clienteProfissao').value = '';
  // PJ
  document.getElementById('clienteNomeFantasia').value = '';
  document.getElementById('clienteRazaoSocial').value = '';
  document.getElementById('clienteCnpj').value = '';
  document.getElementById('clienteRamo').value = '';
  document.getElementById('clienteInscMunicipal').value = '';
  document.getElementById('clienteInscEstadual').value = '';
  document.getElementById('clienteSite').value = '';
  document.getElementById('clienteContatoFinanceiroNome').value = '';
  document.getElementById('clienteContatoFinanceiroWhatsapp').value = '';
  document.getElementById('clienteContatoFinanceiroEmail').value = '';
  // Endere√ßo
  document.getElementById('clienteCep').value = '';
  document.getElementById('clienteLogradouro').value = '';
  document.getElementById('clienteNumero').value = '';
  document.getElementById('clienteComplemento').value = '';
  document.getElementById('clienteBairro').value = '';
  document.getElementById('clienteCidade').value = '';
  document.getElementById('clienteEstado').value = '';
  document.getElementById('clientePontoRef').value = '';
  // Contato
  document.getElementById('clienteWhatsapp').value = '';
  document.getElementById('clienteTelefone').value = '';
  document.getElementById('clienteEmail').value = '';
}

async function buscarCep() {
  const cep = document.getElementById('clienteCep').value.replace(/\D/g, '');
  if (cep.length !== 8) return;
  
  try {
    const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
    const data = await res.json();
    if (!data.erro) {
      document.getElementById('clienteLogradouro').value = data.logradouro || '';
      document.getElementById('clienteBairro').value = data.bairro || '';
      document.getElementById('clienteCidade').value = data.localidade || '';
      document.getElementById('clienteEstado').value = data.uf || '';
    }
  } catch (e) { console.error('Erro ao buscar CEP:', e); }
}

async function salvarNovoCliente() {
  const tipo = document.getElementById('clienteTipo').value;
  
  // Valida√ß√µes b√°sicas
  if (tipo === 'PF') {
    const nome = document.getElementById('clienteNome').value;
    if (!nome) { showToast('Nome √© obrigat√≥rio'); return; }
  } else {
    const nomeFantasia = document.getElementById('clienteNomeFantasia').value;
    if (!nomeFantasia) { showToast('Nome Fantasia √© obrigat√≥rio'); return; }
  }
  
  const whatsapp = document.getElementById('clienteWhatsapp').value;
  if (!whatsapp) { showToast('WhatsApp √© obrigat√≥rio'); return; }
  
  const payload = {
    empresa_id: empresa.id,
    tipo,
    // PF
    nome: tipo === 'PF' ? document.getElementById('clienteNome').value : null,
    sexo: tipo === 'PF' ? document.getElementById('clienteSexo').value : null,
    cpf: tipo === 'PF' ? document.getElementById('clienteCpf').value : null,
    profissao: tipo === 'PF' ? document.getElementById('clienteProfissao').value : null,
    // PJ
    nome_fantasia: tipo === 'PJ' ? document.getElementById('clienteNomeFantasia').value : null,
    razao_social: tipo === 'PJ' ? document.getElementById('clienteRazaoSocial').value : null,
    cnpj: tipo === 'PJ' ? document.getElementById('clienteCnpj').value : null,
    ramo_atuacao: tipo === 'PJ' ? document.getElementById('clienteRamo').value : null,
    inscricao_municipal: tipo === 'PJ' ? document.getElementById('clienteInscMunicipal').value : null,
    inscricao_estadual: tipo === 'PJ' ? document.getElementById('clienteInscEstadual').value : null,
    site: tipo === 'PJ' ? document.getElementById('clienteSite').value : null,
    contato_financeiro_nome: tipo === 'PJ' ? document.getElementById('clienteContatoFinanceiroNome').value : null,
    contato_financeiro_whatsapp: tipo === 'PJ' ? document.getElementById('clienteContatoFinanceiroWhatsapp').value : null,
    contato_financeiro_email: tipo === 'PJ' ? document.getElementById('clienteContatoFinanceiroEmail').value : null,
    // Endere√ßo
    cep: document.getElementById('clienteCep').value,
    logradouro: document.getElementById('clienteLogradouro').value,
    numero: document.getElementById('clienteNumero').value,
    complemento: document.getElementById('clienteComplemento').value,
    bairro: document.getElementById('clienteBairro').value,
    cidade: document.getElementById('clienteCidade').value,
    estado: document.getElementById('clienteEstado').value,
    ponto_referencia: document.getElementById('clientePontoRef').value,
    // Contato
    whatsapp: document.getElementById('clienteWhatsapp').value,
    telefone_fixo: document.getElementById('clienteTelefone').value,
    email: document.getElementById('clienteEmail').value
  };
  
  try {
    const res = await fetch(API_BASE + '/clientes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (res.ok) {
      const novoCliente = await res.json();
      showToast('Cliente cadastrado com sucesso!');
      fecharModalNovoCliente();
      
      // Recarregar lista de clientes e selecionar o novo
      await loadClientes();
      if (novoCliente.id) {
        document.getElementById('preCliente').value = novoCliente.id;
        document.getElementById('visitaCliente').value = novoCliente.id;
      }
    } else {
      const err = await res.json();
      showToast(err.detail || 'Erro ao cadastrar cliente');
    }
  } catch (e) {
    showToast('Erro de conex√£o');
  }
}

// ===== M√°scaras nos inputs =====
document.addEventListener('input', e => {
  if (e.target.id === 'clienteCpf') e.target.value = maskCpf(e.target.value);
  if (e.target.id === 'clienteCnpj') e.target.value = maskCnpj(e.target.value);
  if (e.target.id === 'clienteWhatsapp' || e.target.id === 'clienteTelefone' || e.target.id === 'clienteContatoFinanceiroWhatsapp') 
    e.target.value = maskPhone(e.target.value);
  if (e.target.id === 'clienteCep') e.target.value = maskCep(e.target.value);
});

// ===== Auto Login =====
(async function init() {
  const saved = localStorage.getItem('vendedor');
  const savedEmpresa = localStorage.getItem('empresa');
  
  if (saved && savedEmpresa) {
    vendedor = JSON.parse(saved);
    empresa = JSON.parse(savedEmpresa);
    
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('appScreen').classList.add('show');
    document.getElementById('vendedorNome').textContent = vendedor.nome_completo;
    
    await loadClientes();
    await loadOrcamentos();
    await loadComissoes();
    await loadAgenda();
  }
})();
</script>
</body>
</html>
